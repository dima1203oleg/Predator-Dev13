apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: predator-ci-pipeline
  namespace: predator
spec:
  params:
    - name: git-url
      type: string
      default: https://github.com/your-org/predator-analytics.git
    - name: git-revision
      type: string
      default: main
    - name: image-name
      type: string
    - name: image-tag
      type: string
      default: latest
  
  workspaces:
    - name: shared-workspace
    - name: docker-credentials
  
  tasks:
    # 1. Git Clone
    - name: fetch-repository
      taskRef:
        name: git-clone
      workspaces:
        - name: output
          workspace: shared-workspace
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
    
    # 2. Lint and Format Check
    - name: lint
      runAfter: ["fetch-repository"]
      taskRef:
        name: python-lint
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: args
          value: ["--max-line-length=100", "--ignore=E501"]
    
    # 3. Unit Tests
    - name: unit-tests
      runAfter: ["lint"]
      taskRef:
        name: pytest
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: pytest-args
          value: ["tests/", "--cov=.", "--cov-report=xml", "--cov-report=term-missing"]
    
    # 4. Security Scan (Trivy)
    - name: security-scan
      runAfter: ["fetch-repository"]
      taskRef:
        name: trivy-scan
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: severity
          value: "CRITICAL,HIGH"
        - name: exit-code
          value: "1"
    
    # 5. Build Container Image
    - name: build-image
      runAfter: ["unit-tests", "security-scan"]
      taskRef:
        name: kaniko
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: dockerconfig
          workspace: docker-credentials
      params:
        - name: IMAGE
          value: "$(params.image-name):$(params.image-tag)"
        - name: DOCKERFILE
          value: "./Dockerfile"
        - name: CONTEXT
          value: "."
        - name: EXTRA_ARGS
          value:
            - "--cache=true"
            - "--cache-ttl=24h"
            - "--compressed-caching=false"
    
    # 6. Generate SBOM
    - name: generate-sbom
      runAfter: ["build-image"]
      taskRef:
        name: syft
      params:
        - name: IMAGE
          value: "$(params.image-name):$(params.image-tag)"
        - name: FORMAT
          value: "spdx-json"
    
    # 7. Sign Image (Cosign)
    - name: sign-image
      runAfter: ["generate-sbom"]
      taskRef:
        name: cosign-sign
      params:
        - name: IMAGE
          value: "$(params.image-name):$(params.image-tag)"
        - name: COSIGN_KEY
          value: "k8s://predator/cosign-keys"
    
    # 8. Scan Container Image
    - name: scan-image
      runAfter: ["build-image"]
      taskRef:
        name: trivy-image-scan
      params:
        - name: IMAGE
          value: "$(params.image-name):$(params.image-tag)"
        - name: SEVERITY
          value: "CRITICAL,HIGH"
    
    # 9. Integration Tests
    - name: integration-tests
      runAfter: ["sign-image"]
      taskRef:
        name: pytest-integration
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: test-path
          value: "tests/integration/"
    
    # 10. Update Helm Values
    - name: update-helm
      runAfter: ["integration-tests"]
      taskRef:
        name: yq-replace
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: files
          value: ["helm/predator-umbrella/values-prod.yaml"]
        - name: expression
          value: ".api.image.tag = \"$(params.image-tag)\""
    
    # 11. Trigger ArgoCD Sync
    - name: argocd-sync
      runAfter: ["update-helm"]
      taskRef:
        name: argocd-task-sync
      params:
        - name: application-name
          value: "predator-umbrella"
        - name: flags
          value: "--prune"

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: python-lint
  namespace: predator
spec:
  params:
    - name: args
      type: array
      default: []
  workspaces:
    - name: source
  steps:
    - name: black
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        pip install black ruff
        black --check .
        ruff check .

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: pytest
  namespace: predator
spec:
  params:
    - name: pytest-args
      type: array
      default: []
  workspaces:
    - name: source
  steps:
    - name: test
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        pip install -e .
        pip install pytest pytest-cov pytest-asyncio
        pytest $(params.pytest-args[*])

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: trivy-scan
  namespace: predator
spec:
  params:
    - name: severity
      type: string
      default: "CRITICAL,HIGH"
    - name: exit-code
      type: string
      default: "0"
  workspaces:
    - name: source
  steps:
    - name: scan
      image: aquasec/trivy:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        trivy fs --severity $(params.severity) --exit-code $(params.exit-code) .

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: syft
  namespace: predator
spec:
  params:
    - name: IMAGE
      type: string
    - name: FORMAT
      type: string
      default: "spdx-json"
  steps:
    - name: generate-sbom
      image: anchore/syft:latest
      script: |
        #!/bin/sh
        syft $(params.IMAGE) -o $(params.FORMAT) > sbom.json
        echo "SBOM generated successfully"
