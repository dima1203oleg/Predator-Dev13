# Default values for postgres.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Enable the Bitnami PostgreSQL subchart
postgresql:
  enabled: true
  auth:
    database: predator_db
    username: predator_user
    # password: should be set via secretsRef or ExternalSecrets
  primary:
    persistence:
      enabled: true
      size: 100Gi # Default size, overridden by umbrella values-prod.yaml
    # Add TimescaleDB extension
    initdb:
      scripts:
        create-timescaledb.sh: |
          #!/bin/bash
          set -e
          psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
              CREATE EXTENSION IF NOT EXISTS timescaledb;
          EOSQL
  # Custom resources for PostgreSQL
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi

# Image configuration
image:
  repository: bitnami/postgresql
  tag: "15.4"
  pullPolicy: IfNotPresent

# Service configuration
service:
  type: ClusterIP
  port: 5432

# Autoscaling configuration
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 80

# ServiceAccount configuration
serviceAccount:
  create: true
  name: ""

# Override global settings if needed
global:
  postgresql:
    auth:
      # Pass through secretsRef from umbrella chart
      existingSecret: "predator-secrets"
      secretKeys:
        adminPasswordKey: POSTGRES_PASSWORD
        userPasswordKey: POSTGRES_PASSWORD
        replicationPasswordKey: POSTGRES_REPLICATION_PASSWORD

backup:
  enabled: true
  schedule: "0 2 * * *" # Daily at 2 AM
  image:
    repository: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest
    tag: ubi8-2.41-0
  persistence:
    size: 10Gi # Size for pgBackRest repository
