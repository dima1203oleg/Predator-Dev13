name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/predator-app

jobs:
  lint_test:
    name: Lint & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ['3.10', '3.11']
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run ruff (lint & format)
        run: |
          pip install ruff
          ruff check --fix . || true
          ruff format . || true
      - name: Run pytest
        run: |
          pip install pytest pytest-cov
          mkdir -p reports
          pytest -q --maxfail=1 --junitxml=reports/junit.xml --cov=. --cov-report=term-missing
      - name: Upload junit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: reports/junit.xml

  build_and_push:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: lint_test
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ github.sha }}
            ${{ env.IMAGE_REPO }}:latest
      - name: Set image tag output
        run: echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

  update_manifests:
    name: Update manifests
    runs-on: ubuntu-latest
    needs: build_and_push
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install python yaml lib
        run: python -m pip install pyyaml
      - name: Update Helm values image tag
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          python scripts/update_helm_values.py --file charts/app/values.yaml --image-tag $IMAGE_TAG
      - name: Commit and push manifest changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/app/values.yaml || true
          git commit -m "chore(ci): bump image tag to $IMAGE_TAG" || echo "no changes"
          git push origin HEAD:main || echo "push failed"

  smoke_stack:
    name: Smoke stack
    runs-on: ubuntu-latest
    needs: lint_test
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: predator
          POSTGRES_PASSWORD: predator
          POSTGRES_DB: predator
        options: >-
          --health-cmd="pg_isready -U predator -d predator"
          --health-interval=5s --health-timeout=3s --health-retries=20
      opensearch:
        image: opensearchproject/opensearch:2.14.0
        env:
          discovery.type: single-node
          plugins.security.disabled: "true"
          OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      qdrant:
        image: qdrant/qdrant:v1.11.0
      minio:
        image: minio/minio
        env:
          MINIO_ROOT_USER: minio
          MINIO_ROOT_PASSWORD: minio12345
        options: >-
          --health-cmd="echo ok" --health-interval=5s --health-timeout=3s --health-retries=20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install deps
        run: python -m pip install -U pip && pip install -r requirements-dev.txt
      - name: Smoke: seed + dry-run
        env:
          DB_URL: postgresql://predator:predator@localhost:5432/predator
          OPENSEARCH_URL: http://localhost:9200
          QDRANT_URL: http://localhost:6333
          MINIO_URL: http://localhost:9000
          EXCEL_INPUT: sample.xlsx
          EMBED_MODEL: nomic-embed-text
        run: |
          python scripts/seed_db.py --db "$DB_URL"
          python scripts/parse_index_excel.py --input "$EXCEL_INPUT" --db "$DB_URL" --opensearch "$OPENSEARCH_URL" --qdrant "$QDRANT_URL" --minio "$MINIO_URL" --bucket raw --dry-run --embed-model "$EMBED_MODEL"
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

env:
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/predator-app

jobs:
  lint_test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run ruff (lint & format)
        run: |
          pip install ruff
          ruff check --fix . || true
          ruff format . || true
      - name: Run pytest
        run: |
          pip install pytest
          pytest -q --maxfail=1 --junitxml=reports/junit.xml
      - name: Upload junit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: reports/junit.xml

  build_and_push:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: lint_test
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ github.sha }}
            ${{ env.IMAGE_REPO }}:latest
      - name: Set image tag output
        run: echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

  update_manifests:
    name: Update manifests
    runs-on: ubuntu-latest
    needs: build_and_push
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install python yaml lib
        run: python -m pip install pyyaml
      - name: Update Helm values image tag
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          python scripts/update_helm_values.py --file charts/app/values.yaml --image-tag $IMAGE_TAG
      - name: Commit and push manifest changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/app/values.yaml || true
          git commit -m "chore(ci): bump image tag to $IMAGE_TAG" || echo "no changes"
          git push origin HEAD:main

  smoke_stack:
    name: Smoke stack
    runs-on: ubuntu-latest
    needs: lint_test
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: predator
          POSTGRES_PASSWORD: predator
          POSTGRES_DB: predator
        options: >-
          --health-cmd="pg_isready -U predator -d predator"
          --health-interval=5s --health-timeout=3s --health-retries=20
      opensearch:
        image: opensearchproject/opensearch:2.14.0
        env:
          discovery.type: single-node
          plugins.security.disabled: "true"
          OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      qdrant:
        image: qdrant/qdrant:v1.11.0
      minio:
        image: minio/minio
        env:
          MINIO_ROOT_USER: minio
          MINIO_ROOT_PASSWORD: minio12345
        options: >-
          --health-cmd="echo ok" --health-interval=5s --health-timeout=3s --health-retries=20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install deps
        run: python -m pip install -U pip && pip install -r requirements-dev.txt
      - name: Smoke: seed + dry-run
        env:
          DB_URL: postgresql://predator:predator@localhost:5432/predator
          OPENSEARCH_URL: http://localhost:9200
          QDRANT_URL: http://localhost:6333
          MINIO_URL: http://localhost:9000
          EXCEL_INPUT: sample.xlsx
          EMBED_MODEL: nomic-embed-text
        run: |
          python scripts/seed_db.py --db "$DB_URL"
          python scripts/parse_index_excel.py --input "$EXCEL_INPUT" --db "$DB_URL" --opensearch "$OPENSEARCH_URL" --qdrant "$QDRANT_URL" --minio "$MINIO_URL" --bucket raw --dry-run --embed-model "$EMBED_MODEL"
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

env:
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/predator-app

jobs:
  lint_test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run ruff (lint & format)
        run: |
          pip install ruff
          ruff check --fix . || true
          ruff format . || true
      - name: Run pytest
        run: |
          pip install pytest
          pytest -q --maxfail=1 --junitxml=reports/junit.xml
      - name: Upload junit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: reports/junit.xml
          name: CI

          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]
            workflow_dispatch: {}

          env:
            IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/predator-app

          jobs:
            lint_test:
              name: Lint & Test
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Set up Python
                  uses: actions/setup-python@v4
                  with:
                    python-version: '3.11'
                - name: Install deps
                  run: |
                    python -m pip install --upgrade pip
                    if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
                - name: Run ruff (lint & format)
                  run: |
                    pip install ruff
                    ruff check --fix . || true
                    ruff format . || true
                - name: Run pytest
                  run: |
                    pip install pytest
                    pytest -q --maxfail=1 --junitxml=reports/junit.xml
                - name: Upload junit report
                  if: always()
                  uses: actions/upload-artifact@v4
                  with:
                    name: junit
                    path: reports/junit.xml

            build_and_push:
              name: Build and Push
              runs-on: ubuntu-latest
              needs: lint_test
              permissions:
                contents: write
                packages: write
                id-token: write
              steps:
                - uses: actions/checkout@v4
                - name: Set up QEMU
                  uses: docker/setup-qemu-action@v2
                - name: Set up Docker Buildx
                  uses: docker/setup-buildx-action@v2
                - name: Login to GHCR
                  uses: docker/login-action@v2
                  with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}
                - name: Build and push image
                  uses: docker/build-push-action@v4
                  with:
                    context: .
                    file: ./Dockerfile
                    push: true
                    tags: |
                      ${{ env.IMAGE_REPO }}:${{ github.sha }}
                      ${{ env.IMAGE_REPO }}:latest
                - name: Set image tag output
                  run: echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

            update_manifests:
              name: Update manifests
              runs-on: ubuntu-latest
              needs: build_and_push
              permissions:
                contents: write
              steps:
                - uses: actions/checkout@v4
                - name: Set up Python
                  uses: actions/setup-python@v4
                  with:
                    python-version: '3.11'
                - name: Install python yaml lib
                  run: python -m pip install pyyaml
                - name: Update Helm values image tag
                  env:
                    IMAGE_TAG: ${{ github.sha }}
                  run: |
                    python scripts/update_helm_values.py --file charts/app/values.yaml --image-tag $IMAGE_TAG
                - name: Commit and push manifest changes
                  run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git add charts/app/values.yaml || true
                    git commit -m "chore(ci): bump image tag to $IMAGE_TAG" || echo "no changes"
                    git push origin HEAD:main

            smoke_stack:
              name: Smoke stack
              runs-on: ubuntu-latest
              needs: lint_test
              services:
                postgres:
                  image: postgres:16
                  env:
                    POSTGRES_USER: predator
                    POSTGRES_PASSWORD: predator
                    POSTGRES_DB: predator
                  options: >-
                    --health-cmd="pg_isready -U predator -d predator"
                    --health-interval=5s --health-timeout=3s --health-retries=20
                opensearch:
                  image: opensearchproject/opensearch:2.14.0
                  env:
                    discovery.type: single-node
                    plugins.security.disabled: "true"
                    OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
                qdrant:
                  image: qdrant/qdrant:v1.11.0
                minio:
                  image: minio/minio
                  env:
                    MINIO_ROOT_USER: minio
                    MINIO_ROOT_PASSWORD: minio12345
                  options: >-
                    --health-cmd="echo ok" --health-interval=5s --health-timeout=3s --health-retries=20
              steps:
                - uses: actions/checkout@v4
                - name: Set up Python
                  uses: actions/setup-python@v4
                  with:
                    python-version: "3.11"
                - name: Install deps
                  run: python -m pip install -U pip && pip install -r requirements-dev.txt
                - name: Smoke: seed + dry-run
                  env:
                    DB_URL: postgresql://predator:predator@localhost:5432/predator
                    OPENSEARCH_URL: http://localhost:9200
                    QDRANT_URL: http://localhost:6333
                    MINIO_URL: http://localhost:9000
                    EXCEL_INPUT: sample.xlsx
                    EMBED_MODEL: nomic-embed-text
                  run: |
                    python scripts/seed_db.py --db "$DB_URL"
                    python scripts/parse_index_excel.py --input "$EXCEL_INPUT" --db "$DB_URL" --opensearch "$OPENSEARCH_URL" --qdrant "$QDRANT_URL" --minio "$MINIO_URL" --bucket raw --dry-run --embed-model "$EMBED_MODEL"
            POSTGRES_PASSWORD: predator
            POSTGRES_DB: predator
          options: >-
            --health-cmd="pg_isready -U predator -d predator"
            --health-interval=5s --health-timeout=3s --health-retries=20
        opensearch:
          image: opensearchproject/opensearch:2.14.0
          env:
            discovery.type: single-node
            plugins.security.disabled: "true"
            OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
        qdrant:
          image: qdrant/qdrant:v1.11.0
        minio:
          image: minio/minio
          env:
            MINIO_ROOT_USER: minio
            MINIO_ROOT_PASSWORD: minio12345
          options: >-
            --health-cmd="echo ok" --health-interval=5s --health-timeout=3s --health-retries=20
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v4
          with:
            python-version: "3.11"
        - name: Install deps
          run: python -m pip install -U pip && pip install -r requirements-dev.txt
        - name: Smoke: seed + dry-run
          env:
            DB_URL: postgresql://predator:predator@localhost:5432/predator
            OPENSEARCH_URL: http://localhost:9200
            QDRANT_URL: http://localhost:6333
            MINIO_URL: http://localhost:9000
            EXCEL_INPUT: sample.xlsx
            EMBED_MODEL: nomic-embed-text
          run: |
            python scripts/seed_db.py --db "$DB_URL"
            python scripts/parse_index_excel.py --input "$EXCEL_INPUT" --db "$DB_URL" --opensearch "$OPENSEARCH_URL" --qdrant "$QDRANT_URL" --minio "$MINIO_URL" --bucket raw --dry-run --embed-model "$EMBED_MODEL"
      minio:
