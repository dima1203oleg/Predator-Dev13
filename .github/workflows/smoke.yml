name: Smoke tests

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    smoke:
        name: smoke (docker-compose core)
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
            - name: Set up Docker
              uses: docker/setup-buildx-action@v2
            - name: Start core stack
              run: |
                  docker compose -f .devcontainer/compose.yml --profile core up -d
            - name: Wait for services
              run: |
                  set -e
                  # wait for OpenSearch
                  for i in {1..40}; do
                    curl -sS http://localhost:9200/_cluster/health | grep -q '"status"' && break || sleep 3
                  done
                  # wait for Qdrant
                  for i in {1..40}; do
                    curl -sS http://localhost:6333/health | grep -q 'ok' && break || sleep 3
                  done
                  # wait for API
                  for i in {1..40}; do
                    curl -sS http://localhost:8000/health | grep -q 'healthy' && break || sleep 3
                  done
            - name: Run smoke checks
              run: |
                  chmod +x scripts/test_containers.sh || true
                  ./scripts/test_containers.sh
            - name: Collect logs on success
              if: always()
              run: |
                  mkdir -p smoke-logs
                  docker compose -f .devcontainer/compose.yml --profile core logs > smoke-logs/compose.log || true
            - name: Upload smoke logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: smoke-logs
                  path: smoke-logs
            - name: Tear down
              if: always()
              run: |
                  docker compose -f .devcontainer/compose.yml down -v
