name: cosign-sign-example

on:
    workflow_dispatch:
        inputs:
            image:
                description: "Container image to sign (eg: ghcr.io/myorg/myrepo:tag)"
                required: true

jobs:
    sign:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install cosign
              uses: sigstore/cosign-installer@v2

            - name: Restore cosign private key (from secret)
              env:
                  COSIGN_PRIVATE_KEY_B64: ${{ secrets.COSIGN_PRIVATE_KEY }}
              run: |
                  set -euo pipefail
                  # Do not echo secrets; decode into a file with strict perms
                  echo "Decoding cosign private key into temporary file"
                  echo "$COSIGN_PRIVATE_KEY_B64" | base64 -d > cosign.key
                  chmod 600 cosign.key

            - name: Sign image with cosign
              env:
                  COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
              run: |
                  set -euo pipefail
                  IMAGE="${{ github.event.inputs.image }}"
                  echo "Signing $IMAGE"
                  cosign sign --key cosign.key "$IMAGE"

            - name: Securely remove private key
              run: |
                  set -euo pipefail
                  # Attempt shred when available, otherwise rm
                  if command -v shred >/dev/null 2>&1; then
                    shred -u cosign.key || rm -f cosign.key
                  else
                    rm -f cosign.key
                  fi

            - name: Verify signature (optional)
              run: |
                  set -euo pipefail
                  IMAGE="${{ github.event.inputs.image }}"
                  cosign verify "$IMAGE" || true
